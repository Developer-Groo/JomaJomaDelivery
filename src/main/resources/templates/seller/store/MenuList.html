<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu List</title>
</head>
<style>
    .menu-container {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        border-radius: 10px;
        font-family: Arial, sans-serif;
    }

    .add-menu-button {
        display: block;
        width: fit-content;
        margin: 0 auto 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .add-menu-button:hover {
        background-color: #0056b3;
    }

    .menu-item {
        display: flex;
        align-items: center;
        background-color: white;
        border-radius: 10px;
        margin-bottom: 15px;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .menu-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        margin-right: 10px;
        object-fit: cover;
    }

    .menu-details {
        flex: 1;
    }

    .menu-details h2 {
        margin: 0;
        font-size: 16px;
        color: #333;
    }

    .menu-details p {
        margin: 5px 0 0;
        font-size: 14px;
        color: #555;
    }

    .edit-button {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #007bff;
    }

    .edit-button:hover {
        color: #0056b3;
    }

    /* 모달 창 배경 */
    .modal {
        display: none; /* 기본적으로 숨김 */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    /* 모달 내용 */
    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        border-radius: 10px;
    }

    /* 닫기 버튼 */
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

</style>
<script>
    // 모달 열기: 메뉴 데이터를 입력 필드에 설정
    function handleEditClick(button) {
        const menuItem = button.closest('.menu-item');
        const menuId = menuItem.dataset.menuId;
        const storeId = menuItem.dataset.storeId;
        const name = menuItem.dataset.name;
        const description = menuItem.dataset.description;
        const price = menuItem.dataset.price;
        const imgPath = menuItem.dataset.imgPath;

        openEditModal(menuId, storeId, name, description, price, imgPath);
    }

    function openEditModal(menuId, storeId, name, description, price, imgPath) {
        console.log(`Opening modal for menuId: ${menuId}, storeId: ${storeId}`);
        document.getElementById('editModal').style.display = 'block';
        document.getElementById('menu-id').value = menuId;
        document.getElementById('store-id').value = storeId;
        document.getElementById('name').value = name;
        document.getElementById('description').value = description;
        document.getElementById('price').value = price;
        document.getElementById('imgPath').value = imgPath;
    }

    // 모달 닫기
    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // 수정 폼 제출
    function submitEditForm() {
        const menuId = document.getElementById('menu-id').value;
        const storeId = document.getElementById('store-id').value;
        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;
        const price = document.getElementById('price').value;
        const imgPath = document.getElementById('imgPath').value;

        // 디버깅 로그 추가
        console.log(`Submitting form: menuId=${menuId}, storeId=${storeId}, name=${name}, description=${description}, price=${price}, imgPath=${imgPath}`);

        // 요청 데이터 생성
        const menuData = {
            name: name,
            description: description,
            price: parseInt(price), // 숫자 변환 확인
            img_path: imgPath,
        };

        // PUT 요청 전송
        fetch(`/stores/${storeId}/menus/${menuId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(menuData),
        })
            .then(response => {
                if (response.ok) {
                    alert('수정이 완료되었습니다.');
                    location.reload(); // 새로고침
                } else {
                    console.error('Server response error:', response);
                    alert('수정 중 문제가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('서버와의 통신에 문제가 발생했습니다.');
            });

        closeModal();
    }

    function deleteMenu() {
        const menuId = document.getElementById('menu-id').value;
        const storeId = document.getElementById('store-id').value;

        if (confirm("정말로 이 메뉴를 삭제하시겠습니까?")) {
            fetch(`/stores/${storeId}/menus/${menuId}`, {
                method: 'DELETE',
            })
                .then(response => {
                        location.reload(); // 새로고침
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("서버와의 통신에 문제가 발생했습니다.");
                });
        }
    }


</script>
<body>

<h1>Menu List</h1>

<!-- 페이지 전체에서 storeId를 사용할 수 있도록 설정 -->
<div th:with="storeId=${storeId}">
    <div class="menu-container">
        <div th:each="menu : ${menus}">
            <div class="menu-item"
                 th:data-menu-id="${menu.id}"
                 th:data-store-id="${storeId}"
                 th:data-name="${menu.name}"
                 th:data-description="${menu.description}"
                 th:data-price="${menu.price}"
                 th:data-img-path="${menu.imgPath}">
                <img class="menu-image" th:src="${menu.imgPath}" alt="Menu Image">
                <div class="menu-details">
                    <h2 th:text="${menu.name}"></h2>
                    <p><strong>가격:</strong> <span th:text="${menu.price}"></span>원</p>
                </div>
                <!-- 수정 버튼 -->
                <button class="edit-button" onclick="handleEditClick(this)">✏️</button>
            </div>
        </div>
    </div>
</div>


<!-- 모달 창 -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <form id="editForm">
            <input type="hidden" id="menu-id" name="id"/>
            <input type="hidden" id="store-id" name="storeId"/>
            <label for="name">이름:</label>
            <input type="text" id="name" name="name"/>
            <label for="description">설명:</label>
            <textarea id="description" name="description"></textarea>
            <label for="price">가격:</label>
            <input type="number" id="price" name="price"/>
            <label for="imgPath">이미지 경로:</label>
            <input type="text" id="imgPath" name="imgPath"/>
            <div style="text-align: right;">
                <button type="button" onclick="submitEditForm()">수정하기</button>
                <button type="button" class="delete-button" onclick="deleteMenu()">삭제하기</button>
            </div>
        </form>
    </div>
</div>


</body>
</html>
